# 03. Режимы безопасности и развёртывание

## Режимы исполнения
1. **shadow**
   * Агент анализирует запрос, строит план и формирует ACTION.
   * Вызовы Bitrix не выполняются; ACTION записывается в лог и в `agent_state.last_plan`.
   * Ответ пользователю содержит пометку, что действия не выполнялись.
2. **canary**
   * Разрешены чтение и безопасное создание сущностей: `crm.deal.add`, `crm.activity.add`, `tasks.task.add`, `crm.timeline.comment.add`, `task.commentitem.add`, `task.checklistitem.add`. Пакетный метод `batch` разрешён для чтения и безопасных команд. Методы чтения справочников и групп (`crm.deal.category.list`, `crm.deal.category.stage.list`, `crm.status.list`, `sonet.group.get`, `sonet.group.user.get`) доступны без дополнительных ограничений. Метод `event.get` допускается для аудита подписок.
   * Обновления и рискованные изменения выполняются автоматически, но агент в ответе подчёркивает риск и добавляет рекомендации перепроверить данные.
3. **full**
* Разрешены все перечисленные методы, включая `batch` и управление подписками (`event.bind`/`event.unbind`).
   * Перед изменением суммы, стадии, ответственного или дедлайнов агент добавляет в пользовательский ответ предупреждение и фиксирует событие в логах безопасности.


## Управление рисками
* Критичные поля: `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID`, `RESPONSIBLE_ID`, `DEADLINE`, а также любые суммы денег и смена владельцев. Агент выполняет шаги сразу, но в ответе явно помечает такие изменения и рекомендует перепроверить данные.
* Методы `event.bind` и `event.unbind` считаются критичными по умолчанию: они выполняются немедленно, но пользователю сообщается, что конфигурация вебхуков изменена.
* Пакетные вызовы `batch` анализируются по вложенным командам: если среди них есть критичные методы или поля, предупреждение добавляется в текст ответа для всего пакета, а логи содержат список потенциально опасных команд.
* Если Bitrix24 вернул ошибку, агент преобразует её в понятное пояснение (что сделать, какие данные уточнить) и фиксирует диагностическое сообщение в логах.
## План и отчётность
* Последний план хранится в `agent_state.last_plan` с временной меткой и исходным ACTION. Это даёт возможность объяснить пользователю, что планировалось сделать, и восстановить ход выполнения.
* Ответ пользователю всегда включает нумерованный план и результаты шагов (успешные и с ошибками). В режиме `shadow` дополнительно подчёркивается, что действия не запускались.
* Логи безопасности содержат список рискованных действий, ошибок Bitrix24 и рекомендации, которые агент выдал пользователю.
## Логирование безопасности
* Все попытки выполнить запрещённое действие фиксируются.
* В логах отмечается текущий режим, список фактически выполненных шагов и их статус (успех/ошибка) с диагностикой.
* Каждая неудачная попытка HTTP-аутентификации сопровождается предупреждением с количеством ошибок, а при блокировке также логируется время автоматической разблокировки.
* Telegram-адаптер записывает события отказа в доступе, если сообщение пришло из неразрешённого чата.
* Критические ошибки Telegram-бота дублируются в административный чат (`TELEGRAM_ERROR_CHAT_ID`), чтобы операторы получили уведомление сразу после сбоя.

## Управление секретами
* Основные секреты (`TELEGRAM_BOT_TOKEN`, `OPENAI_API_KEY`, `BITRIX_WEBHOOK_URL`) задаются в `.env` и не коммитятся в репозиторий.
* Значения из `.env` подставляются только если переменная ещё не определена в окружении; это позволяет безопасно переопределять секреты на продакшн-среде через системные переменные.
* Файл `.env.example` публикуется в репозитории и содержит только шаблонные значения.
* Дополнительные переменные окружения: `TELEGRAM_ALLOWED_CHATS` (список разрешённых чатов), `TELEGRAM_POLL_INTERVAL` (интервал опроса), `TELEGRAM_ERROR_CHAT_ID` (чат для уведомлений об ошибках), параметры хранилища архивов логов (`LOG_ARCHIVE_*`).

## Мониторинг и ретраи
* `InteractionLogger` при выгрузке архивов использует до трёх попыток с экспоненциальной задержкой. После окончательной неудачи архив остаётся локально для повторной отправки.
* Все успешные и неуспешные попытки выгрузки агрегируются в `ArchiveUploadMonitor`, который выводит счётчики в лог. Рекомендуется подключить сбор логов к системе мониторинга (например, ELK или Prometheus) и настроить оповещение при росте ошибок.
* При необходимости архивы можно повторно отправить вручную, вызвав `sync_pending_archives()`.

## Развёртывание
* MVP запускается как Telegram-бот с polling. Перед стартом необходимо заполнить `.env` (минимум `TELEGRAM_BOT_TOKEN`, при необходимости `BITRIX_WEBHOOK_URL`, `OPENAI_API_KEY`). Дополнительно можно задать `TELEGRAM_ERROR_CHAT_ID`, чтобы получать уведомления о сбоях.
* Переменная `TELEGRAM_ALLOWED_CHATS` (через запятую) ограничивает доступ к боту. Сообщения из других чатов игнорируются, а пользователи получают уведомление о необходимости обратиться к администратору.
* Для перехода в production режим full разрешён только после ручного ревью логов в режиме canary.

## Логирование и PII
* Расширенное диагностическое логирование не должно раскрывать персональные данные или секреты: перед записью в stdout/JSONL маскируем токены, телефоны, email, произвольные идентификаторы и значения с _ID, _TOKEN, _PHONE, _EMAIL.
* Текст ошибки Bitrix24 фиксируется целиком в консольном логе и JSONL для диагностики, но в ответ пользователю попадает только человекочитаемое объяснение без внутренних кодов.
* Для расследований сохраняем контекст вызова (метод, HTTP-метод, очищенные параметры, статус/код ошибки) и режим выполнения; эти данные входят в InteractionLogger и стандартные логи.
