# 03. Режимы безопасности и развёртывание

## Режимы исполнения
1. **shadow**
   * Агент анализирует запрос, строит план и формирует ACTION.
   * Вызовы Bitrix не выполняются; ACTION записывается в лог и в `agent_state.next_planned_actions`.
   * Ответ пользователю содержит пометку, что действия не выполнялись.
2. **canary**
   * Разрешены чтение и безопасное создание сущностей: `crm.deal.add`, `crm.activity.add`, `tasks.task.add`, `crm.timeline.comment.add`, `task.commentitem.add`, `task.checklistitem.add`. Пакетный метод `batch` разрешён для чтения и безопасных команд. Методы чтения справочников и групп (`crm.deal.category.list`, `crm.deal.category.stage.list`, `crm.status.list`, `sonet.group.get`, `sonet.group.user.get`) доступны без дополнительных ограничений. Метод `event.get` допускается для аудита подписок.
   * Обновления и рискованные изменения блокируются, агент сообщает о необходимости ручного подтверждения.
3. **full**
* Разрешены все перечисленные методы, включая `batch` и управление подписками (`event.bind`/`event.unbind`).
   * Перед изменением суммы, стадии, ответственного, дедлайнов агент обязан спросить подтверждение.
   * Подтверждение фиксируется в `agent_state.confirmations[<ключ>].status = "approved"`, чтобы не запрашивать повторно в рамках одной задачи.

## Запрос подтверждений
* Критичные поля: `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID`, `RESPONSIBLE_ID`, `DEADLINE`, а также любые суммы денег и смена владельцев.
* Методы `event.bind` и `event.unbind` считаются критичными по умолчанию, их выполнение всегда требует явного подтверждения пользователя.
* Пакетные вызовы `batch` анализируются по вложенным командам: если среди них есть критичные методы или поля, подтверждение требуется для всего пакета.
* Модель должна явно указывать `"requires_confirmation": true` для таких шагов. После получения согласия пользователя модель повторяет шаг с `"confirmed": true`.
* Для отказа модель отправляет шаг с `"confirmation_decision": "deny"` (при желании может добавить пояснение в поле `comment`). Оркестратор фиксирует статус `denied` и не будет повторно выполнять шаг без новой явной команды.
* Оркестратор заносит запрос в `agent_state.confirmations` и сообщает пользователю, что ожидается подтверждение или что действие отклонено.
* Без подтверждения вызов не исполняется даже в режиме `full`; при отклонении шаг удаляется из очереди и помечается как `denied`.

## Настройка режима
* Режим задаётся конфигурацией оркестратора (`settings.yaml` или переменная окружения `AGENT_MODE`).
* При каждом шаге режим передаётся в системный промпт, чтобы модель знала ограничения.
* HTTP API принимает запросы только с валидным токеном доступа. Разрешённые токены перечисляются в конфигурации адаптера или в переменной окружения `HTTP_API_TOKENS`. Для всех остальных запросов сервер возвращает `401 unauthorized` и не передаёт данные оркестратору.
* Для защиты от перебора токенов HTTP API ведёт аудит неудачных попыток по IP-адресу. По умолчанию окно аудита (`audit_window_seconds`) равно 900 секундам: если в течение этого времени фиксируется 5 ошибок (`max_failed_attempts`), адрес блокируется на 900 секунд (`block_duration_seconds`). Блокировка сопровождается ответом `429` с заголовком `Retry-After` и записью в лог.
* Успешная аутентификация сбрасывает счётчики ошибок и снимает блокировку, чтобы администратор мог восстановить доступ после корректного входа.

## Логирование безопасности
* Все попытки выполнить запрещённое действие фиксируются.
* В логах отмечается текущий режим и решения по подтверждениям, включая момент одобрения или отказа (`approved_at`/`denied_at`).
* Каждая неудачная попытка HTTP-аутентификации сопровождается предупреждением с количеством ошибок, а при блокировке также логируется время автоматической разблокировки.

## Развёртывание
* MVP запускается локально как CLI-утилита. Конфигурация вебхука Bitrix задаётся переменной `BITRIX_WEBHOOK_URL`; если она не указана, используется URL портала MagnitMedia.
* Для перехода в production режим full разрешён только после ручного ревью логов в режиме canary.
