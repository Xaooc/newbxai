# 03. Режимы безопасности и развёртывание

## Режимы исполнения
1. **shadow**
   * Агент анализирует запрос, строит план и формирует ACTION.
   * Вызовы Bitrix не выполняются; ACTION записывается в лог и в `agent_state.next_planned_actions`.
   * Ответ пользователю содержит пометку, что действия не выполнялись.
2. **canary**
   * Разрешены чтение и безопасное создание сущностей: `crm.deal.add`, `crm.activity.add`, `tasks.task.add`, `crm.timeline.comment.add`, `task.commentitem.add`, `task.checklistitem.add`.
   * Обновления и рискованные изменения блокируются, агент сообщает о необходимости ручного подтверждения.
3. **full**
   * Разрешены все перечисленные методы.
   * Перед изменением суммы, стадии, ответственного, дедлайнов агент обязан спросить подтверждение.
   * Подтверждение фиксируется в `agent_state.confirmations[<ключ>].status = "approved"`, чтобы не запрашивать повторно в рамках одной задачи.

## Запрос подтверждений
* Критичные поля: `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID`, `RESPONSIBLE_ID`, `DEADLINE`, а также любые суммы денег и смена владельцев.
* Модель должна явно указывать `"requires_confirmation": true` для таких шагов. После получения согласия пользователя модель повторяет шаг с `"confirmed": true`.
* Для отказа модель отправляет шаг с `"confirmation_decision": "deny"` (при желании может добавить пояснение в поле `comment`). Оркестратор фиксирует статус `denied` и не будет повторно выполнять шаг без новой явной команды.
* Оркестратор заносит запрос в `agent_state.confirmations` и сообщает пользователю, что ожидается подтверждение или что действие отклонено.
* Без подтверждения вызов не исполняется даже в режиме `full`; при отклонении шаг удаляется из очереди и помечается как `denied`.

## Настройка режима
* Режим задаётся конфигурацией оркестратора (`settings.yaml` или переменная окружения `AGENT_MODE`).
* При каждом шаге режим передаётся в системный промпт, чтобы модель знала ограничения.

## Логирование безопасности
* Все попытки выполнить запрещённое действие фиксируются.
* В логах отмечается текущий режим и решения по подтверждениям, включая момент одобрения или отказа (`approved_at`/`denied_at`).

## Развёртывание
* MVP запускается локально как CLI-утилита. Конфигурация вебхука Bitrix задаётся переменной `BITRIX_WEBHOOK_URL`; если она не указана, используется URL портала MagnitMedia.
* Для перехода в production режим full разрешён только после ручного ревью логов в режиме canary.
