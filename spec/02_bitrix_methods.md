# 02. Методы Bitrix24

## Базовый вебхук
* Все вызовы выполняются через URL `https://portal.magnitmedia.ru/rest/132/1s0mz4mw8d42bfvk/`.
* URL может быть переопределён переменной окружения `BITRIX_WEBHOOK_URL`, но по умолчанию используется указанный портал.
* Модель получает только логические имена методов и параметры, сам URL скрывается.

## Диагностика и логирование
* Каждый вызов Bitrix24 логируется в stdout/stderr на уровне INFO: пишем метод, HTTP-метод, очищенные параметры и идентификатор пользователя запроса.
* В случае ошибки фиксируем код статуса, исходное сообщение Bitrix24 (error, error_description или текст ответа) и рекомендацию повторить действие; запись без усечения попадает в JSONL-поле errors.
* Перед логированием параметры проходят маскирование: токены, email, телефоны и значения с _ID скрываются шаблонами <masked>.

## Разрешённые методы (кратко)
| Метод | Назначение | HTTP по умолчанию | Обязательные параметры | Рискованные поля/действия |
|-------|------------|-------------------|------------------------|---------------------------|
| `user.current` | Информация о владельце вебхука | GET | — | — |
| `user.get` | Поиск пользователей | GET | `filter`/`order`/`select` по необходимости | Нет |
| `crm.contact.list` | Список контактов | GET | `filter` (опционально) | Нет |
| `crm.contact.get` | Контакт по ID | GET | `id` | Нет |
| `crm.company.list` | Список компаний | GET | `filter` (опционально) | Нет |
| `crm.company.get` | Компания по ID | GET | `id` | Нет |
| `crm.deal.list` | Список сделок | GET | `filter`/`select`/`start` | Нет |
| `crm.deal.get` | Сделка по ID | GET | `id` | Нет |
| `crm.deal.add` | Создание сделки | POST | `fields.TITLE` минимум | `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID` |
| `crm.deal.update` | Обновление сделки | POST | `id`, `fields` | Любое изменение суммы, стадии, ответственного |
| `crm.deal.category.list` | Список направлений продаж | GET | — | Нет |
| `crm.deal.category.stage.list` | Список стадий по направлению | GET | `id` или `categoryId` | Нет |
| `crm.status.list` | Элементы справочников CRM | GET | `filter.ENTITY_ID` | Нет |
| `crm.activity.list` | Список активностей | GET | `filter.OWNER_TYPE_ID` (рекомендуется) | Нет |
| `crm.activity.add` | Создание активности | POST | `fields`: `OWNER_TYPE_ID`, `OWNER_ID`, `TYPE_ID`, `SUBJECT` | `RESPONSIBLE_ID`, `DEADLINE` |
| `crm.timeline.comment.add` | Комментарий в таймлайн | POST | `fields`: `ENTITY_ID`, `ENTITY_TYPE`, `COMMENT` | Содержимое текста |
| `tasks.task.add` | Создание задачи | POST | `fields`: `TITLE`, `RESPONSIBLE_ID`, `DESCRIPTION` | `RESPONSIBLE_ID`, `DEADLINE` |
| `tasks.task.update` | Обновление задачи | POST | `taskId` (`id`), `fields` | Ответственный, дедлайн |
| `tasks.task.list` | Список задач | GET | `filter` (опционально) | Нет |
| `task.commentitem.add` | Комментарий к задаче | POST | `taskId`/`TASK_ID`, `fields.POST_MESSAGE` | Текст |
| `task.checklistitem.add` | Пункт чек-листа | POST | `taskId`/`TASK_ID`, `fields.TITLE` | Нет |
| `sonet.group.get` | Информация о рабочих группах | GET | `ID`/`filter` (опционально) | Нет |
| `sonet.group.user.get` | Список участников группы | GET | `GROUP_ID` | Нет |
| `batch` | Пакетный вызов до 50 команд | POST | `cmd` (dict/array), `halt` (опционально) | Наследует ограничения вложенных методов |
| `event.bind` | Привязка обработчика события | POST | `event`, `handler` | Требует подтверждения; меняет конфигурацию |
| `event.get` | Список подписок | GET | — | Нет |
| `event.unbind` | Удаление обработчика события | POST | `event`, `handler` | Требует подтверждения; меняет конфигурацию |
## Детализация по методам

### user.current
* **Назначение.** Получить учётную запись владельца вебхука и проверить его права.
* **Использовать, когда.** Нужно узнать, под каким сотрудником выполняются запросы или вывести имя в отчёте.
* **Не использовать.** Для поиска других сотрудников — для этого есть `user.get`.
* **Параметры.** Не принимает параметров.
* **Ответ.** Объект пользователя Bitrix24 (`ID`, `NAME`, `LAST_NAME`, `EMAIL`, `UF_*`).

### user.get
* **Назначение.** Поиск сотрудников портала (штатных пользователей Bitrix24).
* **Использовать, когда.** Нужно найти коллегу по имени, e-mail, отделу, телефону, должности, получить список активных пользователей.
* **Не использовать.** Для поиска клиентов или CRM-контактов — используем `crm.contact.*`.
* **Обязательные параметры.** Нет, но для фильтрации нужен объект `filter`.
* **Полезные параметры.** `filter` (например, `{"NAME": "Олег"}`, `%` для частичного совпадения, `=`, `!`), `order` (`{"LAST_NAME": "ASC"}`), `select` (ограничение полей).
* **Ответ.** Массив сотрудников (`ID`, `NAME`, `LAST_NAME`, `EMAIL`, `UF_DEPARTMENT`, `ACTIVE`). Количество совпадений возвращается в `total`.

### crm.contact.list
* **Назначение.** Найти клиентов (контактов CRM) по атрибутам.
* **Использовать, когда.** Нужен список потенциальных/текущих клиентов, связанных с сделками, или требуется подобрать контакт по телефону/e-mail.
* **Не использовать.** Для поиска сотрудников портала — только `user.get`.
* **Обязательные параметры.** Нет, но рекомендуется `filter` для ограничения выборки.
* **Полезные параметры.** `filter` (например, `{"%NAME": "Иван", "HAS_PHONE": "Y"}`), `select` (добавить `"PHONE"`, `"EMAIL"`, `"COMPANY_ID"`), `order`, `start` (постраничное чтение).
* **Ответ.** Список до 50 контактов и поле `total` для продолжения. Поля `PHONE`/`EMAIL` возвращаются в виде массивов `[{ "VALUE": "...", "VALUE_TYPE": "WORK" }]`.

### crm.contact.get
* **Назначение.** Получить детальную карточку контакта CRM по ID.
* **Использовать, когда.** Нужно уточнить реквизиты, связанные компании, пользовательские поля перед дальнейшими действиями.
* **Обязательные параметры.** `id`.
* **Ответ.** Полный объект контакта, включая `UF_*`, `COMPANY_ID`, массивы коммуникаций, флаги `HAS_PHONE`, `HAS_EMAIL`.

### crm.company.list
* **Назначение.** Найти компании CRM.
* **Использовать, когда.** Необходимо выбрать юрлиц/организации по отрасли, ответственному, наличию телефонов и т.д.
* **Обязательные параметры.** Нет, но рекомендуется `filter`.
* **Полезные параметры.** `filter` (`{"INDUSTRY": "IT"}`, `{"HAS_PHONE": "Y"}`), `select` (`"PHONE"`, `"EMAIL"`, `"UF_*"`), `order`, `start`.
* **Ответ.** Список компаний до 50 штук и `total` при пагинации.

### crm.company.get
* **Назначение.** Получить карточку компании.
* **Обязательные параметры.** `id`.
* **Ответ.** Поля компании: `TITLE`, `COMPANY_TYPE`, `INDUSTRY`, реквизиты, связанный контакт/сделки, `UF_*`.

### crm.deal.list
* **Назначение.** Подбор сделок по условиям.
* **Использовать, когда.** Нужно вывести список сделок конкретного менеджера, по направлению, стадии, сумме.
* **Обязательные параметры.** Нет; рекомендуется `filter`.
* **Полезные параметры.** `filter` (`{"ASSIGNED_BY_ID": 12}`, `{"CATEGORY_ID": 3}`), `select` (`"ID"`, `"TITLE"`, `"STAGE_ID"`, `"OPPORTUNITY"`), `order`, `start`.
* **Ответ.** До 50 сделок за вызов; поле `next`/`total` при наличии следующих страниц.

### crm.deal.get
* **Назначение.** Получить детальную информацию по сделке.
* **Обязательные параметры.** `id`.
* **Ответ.** Объект сделки с суммой, стадией, направлением, ответственным, связанными контактами и компаниями, UTM-метками, пользовательскими полями.

### crm.deal.add
* **Назначение.** Создать сделку.
* **Обязательные параметры.** `fields.TITLE`.
* **Полезные параметры.** `fields`: `TYPE_ID`, `CATEGORY_ID`, `STAGE_ID`, `COMPANY_ID`, `CONTACT_ID`, `ASSIGNED_BY_ID`, `OPPORTUNITY`, `CURRENCY_ID`, даты, `UF_*`.
* **Особенности.** Без `STAGE_ID`/`CATEGORY_ID` сделка попадёт на стартовую стадию направления 0. Любые суммы и назначение ответственного требуют подтверждения.

### crm.deal.update
* **Назначение.** Обновить параметры сделки.
* **Обязательные параметры.** `id`, объект `fields` (не пустой).
* **Особенности.** Изменение `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID` обязательно требует подтверждения. Метод возвращает `true`.

### crm.deal.category.list
* **Назначение.** Получить список направлений продаж (воронок).
* **Обязательные параметры.** Нет.
* **Ответ.** Массив объектов с `ID`, `NAME`, `SORT`, `IS_DEFAULT`.

### crm.deal.category.stage.list
* **Назначение.** Получить стадии конкретного направления.
* **Обязательные параметры.** `id` или `categoryId`.
* **Ответ.** Список стадий (`STATUS_ID`, `NAME`, `SEMANTICS`, `SORT`). `SEMANTICS`: `P` — в работе, `S` — успешные, `F` — провальные.

### crm.status.list
* **Назначение.** Выгрузка справочников CRM.
* **Обязательные параметры.** `filter.ENTITY_ID` (например, `DEAL_STAGE`, `SOURCE`, `STATUS`).
* **Полезные параметры.** `filter.CATEGORY_ID`, `filter.STATUS_ID`, `select`.
* **Ответ.** Массив элементов с `STATUS_ID`, `NAME`, `SORT`, `SYSTEM`, `COLOR`.

### crm.activity.list
* **Назначение.** Получить список дел (звонки, письма, встречи).
* **Обязательные параметры.** Нет, но для перфоманса следует задавать `filter.OWNER_TYPE_ID`/`OWNER_ID`.
* **Полезные параметры.** Фильтры по завершённости (`COMPLETED`), дедлайну (`>DEADLINE`), типу (`TYPE_ID`), ответственному (`RESPONSIBLE_ID`), `select`.
* **Ответ.** Массив активностей, поле `total` при постраничном чтении.

### crm.activity.add
* **Назначение.** Создать дело в CRM.
* **Обязательные параметры.** `fields.OWNER_TYPE_ID`, `fields.OWNER_ID`, `fields.TYPE_ID`, `fields.SUBJECT`.
* **Полезные параметры.** `fields.START_TIME`, `fields.END_TIME`, `fields.RESPONSIBLE_ID`, `fields.DESCRIPTION`, `fields.COMMUNICATIONS`.
* **Особенности.** Изменение `RESPONSIBLE_ID` и установка дедлайнов требует подтверждения.

### crm.timeline.comment.add
* **Назначение.** Добавить текстовый комментарий в таймлайн сущности.
* **Обязательные параметры.** `fields.ENTITY_ID`, `fields.ENTITY_TYPE` (`deal`, `lead`, `contact`, `company`, `task` и т.д.), `fields.COMMENT`.
* **Ответ.** ID созданного комментария.

### tasks.task.add
* **Назначение.** Создать задачу Bitrix24.
* **Обязательные параметры.** `fields.TITLE`, `fields.DESCRIPTION`, `fields.RESPONSIBLE_ID`.
* **Полезные параметры.** `fields.CREATED_BY`, `fields.DEADLINE`, `fields.GROUP_ID`, `fields.AUDITORS`, `fields.ACCOMPLICES`, `fields.TAGS`, `fields.UF_CRM_TASK`.
* **Особенности.** `RESPONSIBLE_ID` и `DEADLINE` требуют подтверждения.

### tasks.task.update
* **Назначение.** Обновить существующую задачу.
* **Обязательные параметры.** `taskId` (или `id`), объект `fields`.
* **Особенности.** Меняем только переданные поля; изменение ответственного/дедлайна требует подтверждения.

### tasks.task.list
* **Назначение.** Перечислить задачи по условиям.
* **Полезные параметры.** `filter` (`{"RESPONSIBLE_ID": 12}`, `{"STATUS": 2}`, `{"GROUP_ID": 5}`), `select` (добавить пользовательские поля), `start`.
* **Ответ.** Массив задач и `total` (если сервер вернул количество).

### task.commentitem.add
* **Назначение.** Оставить комментарий в задаче.
* **Обязательные параметры.** `taskId` (или `TASK_ID`), `fields.POST_MESSAGE`.
* **Ответ.** ID комментария (элемент форума задач).

### task.checklistitem.add
* **Назначение.** Добавить пункт чек-листа задачи.
* **Обязательные параметры.** `taskId` (или `TASK_ID`), `fields.TITLE`.
* **Полезные параметры.** `fields.PARENT_ID`, `fields.SORT_INDEX`, `fields.RESPONSIBLE_ID`, `fields.IS_COMPLETE`.

### sonet.group.get
* **Назначение.** Получить сведения о рабочих группах/проектах.
* **Обязательные параметры.** Нет; можно передать `ID` (число) или `filter`.
* **Полезные параметры.** `filter.NAME`, `filter.OWNER_ID`, `filter.CLOSED`, `select`.
* **Ответ.** Список групп с `ID`, `NAME`, `DESCRIPTION`, `OWNER_ID`, `PROJECT`, `NUMBER_OF_MEMBERS`, `DATE_CREATE`.

### sonet.group.user.get
* **Назначение.** Получить список участников рабочей группы.
* **Обязательные параметры.** `GROUP_ID`.
* **Ответ.** Массив участников `{"USER_ID": ..., "ROLE": "A|E|M", "AUTO_MEMBER": "Y|N"}`.

### batch
* **Назначение.** Выполнить до 50 команд за один HTTP-запрос.
* **Обязательные параметры.** `cmd` — словарь `{"alias": "method?param=value"}` или массив строк.
* **Особенности.** Оркестратор проверяет каждый подзапрос: метод должен быть разрешён для текущего режима, вложенный `batch` запрещён. Если хотя бы одна команда изменяет критичные поля или требует подтверждения, весь пакет помечается как требующий подтверждения.
* **Ответ.** `result.result` — словарь по alias, `result.result_error` — ошибки подзапросов. Параметр `halt=1` позволяет остановить выполнение при первой ошибке.

### event.bind
* **Назначение.** Подписаться на событие Bitrix24.
* **Обязательные параметры.** `event` (код события, например, `onCrmDealAdd`), `handler` (URL обработчика).
* **Особенности.** Всегда требует пользовательского подтверждения. При успехе `{"result": true}` и запись добавляется в `agent_state.event_bindings`.

### event.get
* **Назначение.** Получить все активные подписки вебхука.
* **Параметры.** Не принимает параметров.
* **Ответ.** Список `{"event": "...", "handler": "..."}`. Используется для синхронизации состояния `agent_state.event_bindings`.

### event.unbind
* **Назначение.** Снять подписку на событие.
* **Обязательные параметры.** `event`, `handler` (должны совпадать с существующей подпиской).
* **Особенности.** Всегда требует подтверждения. При успехе `{"result": true}`, запись удаляется из `agent_state.event_bindings`.

## Общие требования
* Все вызовы выполняются через обёртку `call_bitrix` из модуля `bitrix_client`.
* Агент валидирует обязательные поля до вызова и сообщает пользователю, если данных не хватает.
* При ошибке Bitrix агент передаёт пользователю код и описание (`error` / `error_description`).
* Ожидаемый успешный ответ содержит поле `result` и метаданные `time`.

### batch
* Позволяет сгруппировать до 50 подзапросов Bitrix24 за один HTTP-вызов.
* `cmd` — словарь или массив строк вида `ключ: "crm.deal.get?id=123"`. Метод в строке определяется префиксом до `?`.
* Оркестратор проверяет каждый подзапрос: разрешён ли метод, не изменяет ли он критичные поля без подтверждения. При нарушении пакет блокируется.
* Ответ содержит `result.result` с данными по ключам и `result.result_error` для ошибок подзапросов. Поле `result.total` отсутствует, поэтому количество элементов фиксируется в истории состояний вручную.

### event.bind
* Регистрирует обработчик события (`event`, например `onCrmDealAdd`) на заданный URL `handler`.
* Всегда требует подтверждения пользователя и доступен только в режиме `full`.
* Успешный ответ `{ "result": true }` заставляет оркестратор добавить подписку в `agent_state.event_bindings`.

### event.get
* Возвращает список активных подписок вебхука.
* Доступен в режимах `canary` и `full`.
* Результат — массив объектов `{ "event": ..., "handler": ... }`, которым замещается `agent_state.event_bindings`.

### event.unbind
* Удаляет ранее созданную подписку (`event`, `handler`).
* Всегда требует подтверждения пользователя и доступен только в режиме `full`.
* При успехе `{ "result": true }` оркестратор удаляет запись из `agent_state.event_bindings`.
