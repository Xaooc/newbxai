# 02. Методы Bitrix24

## Базовый вебхук
* Все вызовы выполняются через URL `https://portal.magnitmedia.ru/rest/132/1s0mz4mw8d42bfvk/`.
* URL может быть переопределён переменной окружения `BITRIX_WEBHOOK_URL`, но по умолчанию используется указанный портал.
* Модель получает только логические имена методов и параметры, сам URL скрывается.

## Разрешённые методы (кратко)
| Метод | Назначение | Обязательные параметры | Рискованные поля/действия |
|-------|------------|------------------------|---------------------------|
| `user.current` | Информация о владельце вебхука | — | — |
| `user.get` | Поиск пользователей | `filter`/`order`/`select` по необходимости | Нет |
| `crm.contact.list` | Список контактов | `filter` (опционально) | Нет |
| `crm.contact.get` | Контакт по ID | `id` | Нет |
| `crm.company.list` | Список компаний | `filter` (опционально) | Нет |
| `crm.company.get` | Компания по ID | `id` | Нет |
| `crm.deal.list` | Список сделок | `filter`/`select`/`start` | Нет |
| `crm.deal.get` | Сделка по ID | `id` | Нет |
| `crm.deal.add` | Создание сделки | `fields.TITLE` минимум | `OPPORTUNITY`, `ASSIGNED_BY_ID`, `STAGE_ID`, `CATEGORY_ID` |
| `crm.deal.update` | Обновление сделки | `id`, `fields` | Любое изменение суммы, стадии, ответственного |
| `crm.deal.category.list` | Список направлений продаж | — | Нет |
| `crm.deal.category.stage.list` | Список стадий по направлению | `id` | Нет |
| `crm.status.list` | Элементы справочников CRM | `filter.ENTITY_ID` | Нет |
| `crm.activity.list` | Список активностей | `filter` | Нет |
| `crm.activity.add` | Создание активности | `fields`: `OWNER_TYPE_ID`, `OWNER_ID`, `TYPE_ID`, `SUBJECT` | `RESPONSIBLE_ID`, `DEADLINE` |
| `crm.timeline.comment.add` | Комментарий в таймлайн | `fields`: `ENTITY_ID`, `ENTITY_TYPE`, `COMMENT` | Содержимое текста |
| `tasks.task.add` | Создание задачи | `fields`: `TITLE`, `RESPONSIBLE_ID`, `DESCRIPTION` | `RESPONSIBLE_ID`, `DEADLINE` |
| `tasks.task.update` | Обновление задачи | `taskId`, `fields` | Ответственный, дедлайн |
| `tasks.task.list` | Список задач | `filter` | Нет |
| `task.commentitem.add` | Комментарий к задаче | `taskId`, `fields.POST_MESSAGE` | Текст |
| `task.checklistitem.add` | Пункт чек-листа | `taskId`, `fields.TITLE` | Нет |
| `sonet.group.get` | Информация о рабочих группах | `ID`/`filter` (опционально) | Нет |
| `sonet.group.user.get` | Список участников группы | `GROUP_ID` | Нет |
| `batch` | Пакетный вызов до 50 команд | `cmd` (dict/array), `halt` (опционально) | Наследует ограничения вложенных методов |
| `event.bind` | Привязка обработчика события | `event`, `handler` | Требует подтверждения; меняет конфигурацию |
| `event.get` | Список подписок | — | Нет |
| `event.unbind` | Удаление обработчика события | `event`, `handler` | Требует подтверждения; меняет конфигурацию |
## Детализация по методам

### user.current
* Возвращает объект текущего пользователя, от чьего имени выполняется вебхук.
* Используется для диагностики прав и отображения имени в отчётах.
* Пример ответа: `{"ID": "1", "NAME": "Антон", ...}`.

### user.get
* Поддерживает параметры `filter`, `order`, `select`.
* При поиске по имени используем фильтр `{"NAME": "Олег"}`; допускаются операторы (`%`, `!`).
* Для массовых выборок рекомендуется ограничивать поля `select`, чтобы уменьшить размер ответа.

### crm.contact.list / crm.contact.get
* Поля `PHONE` и `EMAIL` множественные — в `select` явно указывать `"PHONE"`, `"EMAIL"`.
* Поиск по номеру: `{"PHONE": "+74951234567"}`.
* Метод `get` возвращает полный объект, включая пользовательские поля `UF_*`.

### crm.company.list / crm.company.get
* Аналогично контактам, множественные поля требуют явного `select`.
* Поля `COMPANY_TYPE`, `INDUSTRY`, `EMPLOYEES` помогают сегментировать клиентов.

### crm.deal.list
* Максимум 50 записей за вызов; используем `start` для постраничного чтения.
* Частые фильтры: `{"ASSIGNED_BY_ID": <id>}`, `{"%TITLE": "Продажа"}`, `{"CATEGORY_ID": 5}`.
* Для анализа прогресса можно запрашивать `STAGE_ID`, `OPPORTUNITY`, `DATE_CREATE`.

### crm.deal.get
* Возвращает все поля сделки, в том числе пользовательские и UTM-метки.
* Используется для проверки перед обновлением, чтобы не потерять данные.

### crm.deal.add
* Обязателен `fields.TITLE`; при множественных воронках задаём `CATEGORY_ID` и `STAGE_ID`.
* Рискованные поля: `OPPORTUNITY`, `CURRENCY_ID`, `ASSIGNED_BY_ID` — требуют подтверждения в режиме `full`.
* Пример тела запроса:
  ```json
  {
    "fields": {
      "TITLE": "Продажа оборудования",
      "CONTACT_ID": 123,
      "ASSIGNED_BY_ID": 7,
      "OPPORTUNITY": 150000,
      "CURRENCY_ID": "RUB"
    }
  }
  ```

### crm.deal.update
* Меняет только указанные поля. Перед изменением суммы или стадии требуется подтверждение.
* Для фиксации подтверждения модель должна указать `"confirmed": true` в шаге ACTION.

### crm.deal.category.list
* Возвращает список направлений продаж (воронок) CRM.
* Параметр `filter` опционален; если не задан, возвращаются все категории.
* В ответе массив объектов с полями `ID`, `NAME`, `SORT`, `IS_DEFAULT`.

### crm.deal.category.stage.list
* Возвращает стадии сделок для конкретного направления.
* Обязателен параметр `id` (либо `categoryId`), задающий идентификатор направления.
* Каждый элемент содержит `CATEGORY_ID`, `STATUS_ID`, `NAME`, `SORT`, `SEMANTICS`.

### crm.status.list
* Универсальный метод для чтения справочников CRM.
* Обязателен фильтр `{"ENTITY_ID": <код справочника>}`. Дополнительно можно фильтровать по `STATUS_ID`, `CATEGORY_ID` и т.д.
* Используется для получения стадий сделок (`ENTITY_ID = "DEAL_STAGE"`), источников, отраслей, размеров компаний и других списков.
* Ответ — массив объектов с идентификаторами и названиями значений.

### crm.activity.list
* Требует `OWNER_TYPE_ID` (лид=1, сделка=2, контакт=3, компания=4) и при необходимости `OWNER_ID`.
* Для актуальных дел используем `{"COMPLETED": "N"}`.

### crm.activity.add
* Стандартные типы: `1` — встреча, `2` — звонок, `3` — email.
* `START_TIME`/`END_TIME` задаём в ISO8601; при звонках добавляем `COMMUNICATIONS` с телефоном.
* Рискованные поля: `RESPONSIBLE_ID`, `DEADLINE` — требуют подтверждения в режиме `full`.

### crm.timeline.comment.add
* `ENTITY_TYPE` — строчные значения (`"deal"`, `"lead"`, `"contact"`, `"company"`).
* Текст комментария должен быть согласован с пользователем.

### tasks.task.add
* Минимум: `TITLE`, `RESPONSIBLE_ID`, `DESCRIPTION`.
* `DEADLINE` — формат `YYYY-MM-DD HH:MM:SS` либо ISO8601 в часовом поясе портала.
* Ответ содержит `result.task.id`, который сохраняем в состоянии.

### tasks.task.update
* URL-параметр `taskId` обязателен.
* Изменение ответственного или дедлайна — рискованное действие и требует подтверждения.

### tasks.task.list
* Фильтры: `RESPONSIBLE_ID`, `CREATED_BY`, `STATUS`, `>=DEADLINE`, `!RESPONSIBLE_ID` и т.д.
* Ответ содержит `total` и `result` с объектами задач.

### task.commentitem.add
* `fields.POST_MESSAGE` принимает текст комментария (поддерживает BBCode).
* Возвращает числовой ID комментария.

### task.checklistitem.add
* Добавляет пункт в чек-лист задачи. Для управления порядком используем `SORT_INDEX`.

### sonet.group.get
* Возвращает данные рабочих групп (проектов) соцсети Bitrix24.
* Можно запрашивать конкретные группы по `ID` или использовать фильтры (например, по названию, владельцу).
* В ответе перечислены поля `ID`, `NAME`, `DESCRIPTION`, `OWNER_ID`, `PROJECT`, `CLOSED`, `NUMBER_OF_MEMBERS` и др.

### sonet.group.user.get
* Возвращает список участников рабочей группы.
* Обязателен параметр `GROUP_ID`.
* Каждый элемент содержит `USER_ID` и `ROLE` (`A` — владелец, `E` — руководитель/модератор, `M` — участник).

## Общие требования
* Все вызовы выполняются через обёртку `call_bitrix` из модуля `bitrix_client`.
* Агент валидирует обязательные поля до вызова и сообщает пользователю, если данных не хватает.
* При ошибке Bitrix агент передаёт пользователю код и описание (`error` / `error_description`).
* Ожидаемый успешный ответ содержит поле `result` и метаданные `time`.

### batch
* Позволяет сгруппировать до 50 подзапросов Bitrix24 за один HTTP-вызов.
* `cmd` — словарь или массив строк вида `ключ: "crm.deal.get?id=123"`. Метод в строке определяется префиксом до `?`.
* Оркестратор проверяет каждый подзапрос: разрешён ли метод, не изменяет ли он критичные поля без подтверждения. При нарушении пакет блокируется.
* Ответ содержит секцию `result.result` с данными по ключам. Ошибки подзапросов попадают в `result.result_error` — их необходимо транслировать пользователю.

### event.bind
* Регистрирует вебхук-обработчик для события Bitrix24. Требует параметры `event` (код события) и `handler` (URL обработчика).
* Всегда требует подтверждения пользователя и доступен только в режиме full.
* Успешный ответ `{ "result": true }` — оркестратор синхронизирует запись в `agent_state.event_bindings`.

### event.get
* Возвращает список активных подписок для текущего вебхука.
* Разрешён в canary и full режимах, полезен для диагностики.
* Результат — массив объектов `{ "event": ..., "handler": ... }`, которым замещается `agent_state.event_bindings`.

### event.unbind
* Удаляет ранее созданную подписку. Требуются `event` и `handler`, совпадающие с параметрами `event.bind`.
* Всегда требует подтверждения пользователя и доступен только в режиме full.
* При успехе `{ "result": true }` оркестратор удаляет соответствующую запись из `agent_state.event_bindings`.
