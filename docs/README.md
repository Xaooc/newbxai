# AI-менеджер Bitrix24 (MVP)

## Описание
Проект реализует минимально жизнеспособную версию агента, который принимает запросы пользователей и управляет Bitrix24 через REST API. Оркестратор работает в консольном режиме, хранит состояние между запусками и ведёт логирование.

## Требования
* Python 3.11+
* Доступ к интернету для вызовов Bitrix24 и GPT-5 Thinking (при необходимости)
* Внешний вебхук Bitrix24
* API-ключ OpenAI или совместимой платформы (для работы GPT-клиента)

## Установка зависимостей
```
pip install -r requirements.txt
```
(Файл `requirements.txt` следует дополнить по мере интеграции реальных библиотек. Для текущего MVP достаточно `requests`.)

## Настройка Bitrix24
1. Используйте преднастроенный вебхук портала `https://portal.magnitmedia.ru/rest/132/1s0mz4mw8d42bfvk/` либо создайте собственный с аналогичными правами.
2. При необходимости переопределите URL переменной окружения `BITRIX_WEBHOOK_URL` или в локальном `.env` (файл не попадает в репозиторий).
3. Если переменная не задана, клиент автоматически использует URL MagnitMedia.

## Настройка GPT-5 Thinking
1. Получите API-ключ и задайте `OPENAI_API_KEY` в переменных окружения.
2. При работе с нестандартным хостом дополнительно задайте `OPENAI_API_BASE` (по умолчанию используется официальный `https://api.openai.com/v1`).
3. При старте оркестратора наличие ключа проверяется автоматически. Если ключ не задан или сеть недоступна, агент перейдёт в деградационный режим и сообщит об этом пользователю.

## Хранение состояния
* Состояние пользователя (`agent_state`) хранится в JSON-файлах в каталоге, заданном параметром `--state-dir` (по умолчанию `./data/state`).
* Формат состояния описан в `spec/04_state_and_memory.md`.
* Каждый файл называется по идентификатору пользователя (`<user_id>.json`).

## Логи
* Логи сохраняются в формате JSONL в каталоге `--log-dir` (по умолчанию `./data/logs`).
* Каждая запись содержит исходное сообщение, блоки THOUGHT/ACTION/ASSISTANT и результаты вызовов Bitrix.

## Запуск оркестратора
```
python -m src.main_entrypoint <user_id> "<сообщение>" --mode shadow
```
Параметр `--mode` задаёт режим безопасности (`shadow`, `canary`, `full`). В режиме `shadow` действия не исполняются, только планируются.

## Дальнейшая настройка
* Доработать поток подтверждений: модель должна помечать рискованные действия `confirmed: true` после получения согласия.
* Подключить пользовательский интерфейс (например, Telegram-бот или веб-сервер).
* Настроить систему автоматических тестов и мониторинг качества ответов.
